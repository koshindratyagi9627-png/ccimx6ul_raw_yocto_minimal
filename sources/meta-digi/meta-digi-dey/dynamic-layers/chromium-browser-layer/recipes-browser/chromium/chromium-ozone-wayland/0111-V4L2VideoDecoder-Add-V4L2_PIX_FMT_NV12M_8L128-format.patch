From fe9d852a4f33d4efdcbf52e761a9c32c76970517 Mon Sep 17 00:00:00 2001
From: Hou Qi <qi.hou@nxp.com>
Date: Fri, 13 Sep 2024 22:59:46 +0900
Subject: [PATCH 11/19] V4L2VideoDecoder: Add V4L2_PIX_FMT_NV12M_8L128 format
 for amphion

Upstream-Status: Inappropriate [NXP specific]
---
 media/gpu/chromeos/fourcc.cc  | 2 ++
 media/gpu/chromeos/fourcc.h   | 4 ++++
 media/gpu/v4l2/v4l2_device.cc | 1 +
 media/gpu/v4l2/v4l2_device.h  | 6 ++++++
 4 files changed, 13 insertions(+)

diff --git a/media/gpu/chromeos/fourcc.cc b/media/gpu/chromeos/fourcc.cc
index 5b7444a7b6319..6236034447322 100644
--- a/media/gpu/chromeos/fourcc.cc
+++ b/media/gpu/chromeos/fourcc.cc
@@ -24,6 +24,7 @@ std::optional<Fourcc> Fourcc::FromUint32(uint32_t fourcc) {
     case YM12:
     case YM21:
     case YUYV:
+    case NA12:
     case NV12:
     case NV21:
     case NM12:
@@ -172,6 +173,7 @@ VideoPixelFormat Fourcc::ToVideoPixelFormat() const {
       return PIXEL_FORMAT_YUY2;
     case NV12:
     case NM12:
+    case NA12:
       return PIXEL_FORMAT_NV12;
     case NV21:
     case NM21:
diff --git a/media/gpu/chromeos/fourcc.h b/media/gpu/chromeos/fourcc.h
index 6f08dba1de919..12b71cbb8f394 100644
--- a/media/gpu/chromeos/fourcc.h
+++ b/media/gpu/chromeos/fourcc.h
@@ -69,6 +69,10 @@ class MEDIA_GPU_EXPORT Fourcc {
     // Maps to PIXEL_FORMAT_NV21, V4L2_PIX_FMT_NV21M.
     NM21 = ComposeFourcc('N', 'M', '2', '1'),
 
+    // Tiled YUV formats, non contiguous planes.
+    // Maps to V4L2_PIX_FMT_NV12M_8L128.
+    NA12 = ComposeFourcc('N', 'A', '1', '2'),
+
     // YUV422 single-planar format.
     // https://linuxtv.org/downloads/v4l-dvb-apis-new/userspace-api/v4l/pixfmt-yuv422p.html
     // Maps to PIXEL_FORMAT_I422, V4L2_PIX_FMT_YUV422P.
diff --git a/media/gpu/v4l2/v4l2_device.cc b/media/gpu/v4l2/v4l2_device.cc
index c04873fe2ae84..08a3fe203cb81 100644
--- a/media/gpu/v4l2/v4l2_device.cc
+++ b/media/gpu/v4l2/v4l2_device.cc
@@ -42,6 +42,7 @@ uint32_t V4L2PixFmtToDrmFormat(uint32_t format) {
   switch (format) {
     case V4L2_PIX_FMT_NV12:
     case V4L2_PIX_FMT_NV12M:
+    case V4L2_PIX_FMT_NV12M_8L128:
       return DRM_FORMAT_NV12;
 
     case V4L2_PIX_FMT_YUV420:
diff --git a/media/gpu/v4l2/v4l2_device.h b/media/gpu/v4l2/v4l2_device.h
index 2d2800f3925f5..34e1b4d9380b2 100644
--- a/media/gpu/v4l2/v4l2_device.h
+++ b/media/gpu/v4l2/v4l2_device.h
@@ -63,6 +63,12 @@
   v4l2_fourcc('Q', '1', '0', 'C') /* Qualcomm 10-bit compressed */
 #endif
 
+/* Tiled YUV formats, non contiguous planes */
+#ifndef V4L2_PIX_FMT_NV12M_8L128
+#define V4L2_PIX_FMT_NV12M_8L128 \
+  v4l2_fourcc('N', 'A', '1', '2') /* Y/CbCr 4:2:0 8x128 tiles */
+#endif
+
 #define V4L2_PIX_FMT_INVALID v4l2_fourcc('0', '0', '0', '0')
 
 namespace media {
-- 
2.34.1

